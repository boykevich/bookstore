@page "/"
@using Microsoft.AspNetCore.Components
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@inject ApplicationDbContext DbContext
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Home</PageTitle>

<!-- Top Navigation Bar -->
<div class="top-bar">
    <div class="logo">
        <h2>BookStore</h2>
    </div>
    <div class="search-bar">
        <InputText @bind-Value="SearchQuery" placeholder="Enter desired book..." class="search-input" />
        <button @onclick="PerformSearch" class="search-button">🔍 Search</button>
    </div>
    <div class="cart">
        <a href="/cartpage">
            <span class="cart-icon">🛒</span> <span class="cart-count">@(cart?.Items.Count() ?? 0)</span>
        </a>
    </div>
</div>

<!-- Main Content -->
<div class="main-content">
    <p>Welcome to your new app.</p>
</div>

@code {
    private string SearchQuery { get; set; } = "";
    private Cart? cart;

    private void PerformSearch()
    {
        Console.WriteLine($"Searching for: {SearchQuery}");
        // NavigationManager.NavigateTo($"/search?query={SearchQuery}");
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userId = user.FindFirstValue(ClaimTypes.NameIdentifier);

            cart = await DbContext.Carts
                .Include(c => c.Items)
                .FirstOrDefaultAsync(c => c.UserId == userId);
        }
    }
}
